
# Replication bit

# Load packages
library(foreign)
library(stargazer)
library(tidyverse)
library(Hmisc)
library(readstata13)
library(haven)
library(texreg)
library(xtable)
library(knitr)
library(vtable)
library(plm)
library(dplyr)
library(magrittr)

# Set directory
setwd("/Users/yangshuya/Desktop/Jasmine Yang/PhD/Econometrics 2/Replication/Replication/data")

# Starting by looking at the yearly-obs data for summary characteristics
DF <- read.dta13("yearly-obs.dta")

order(DF$fips, DF$year)

# First look at data
head(DF)
summary(DF$repsharey)
summary(DF)

# Creating summary statistics table (table 1)

DF_sum <- c("repshare", "turnout", "popsd", "capital_state", "airport", 
            "lnincome", "poverty", "gini", "racialhhi", "mentalhealth", 
            "pop15t39", "nevermarried", "sc", "lnhom_gun", "lnsui_gun", 
            "lncrime_violent", "lncrime_proprty")
            
sumdata <- DF[DF_sum]

labs <- c("Republican share", "Turnout", 
          "Population (standardized)", "State capitol",
          "Major city", "Log (median HH income)", 
          "Poverty rate","Inequality (Gini Index)", 
          "Racial diversity HHI", 
          "Proportion with mental issues", 
          "Population 15 to 39 years", "Single",
          "College dropouts", "Log (homicides by gun)", 
          "Log (suicides by Gun)","Log (violent crime)",
          "Log (property crime)")

st(sumdata, add.median=TRUE, labels=labs, 
   digits = 2, fixed.digits = FALSE, numformat = NA, out="latex", 
   title='Summary Statistics')

# Table 2
# Strategy 1: Checking if counties with/without mass shootings and counties with
# successful vs. failed mass shootings are different in observable
# characteristics

# Creating vector of variable names to create lags for
var_names <- c("repshare", "turnout", "capital_state", "lnincome", "poverty", 
               "gini", "racialhhi", "mentalhealth", "pop15t39", "nevermarried", "sc", 
               "lnhom_gun", "lnsui_gun", "lncrime_violent", "lncrime_proprty")

# Generate lagged variables for each variable in var_names
for (var_name in var_names) {
  DF[[paste0(var_name, "_lag1")]] <- c(NA, DF[[var_name]][-nrow(DF)])
}

# Regress the lagged variables on ms and popsd
# define variables to lag and regress
vars_to_lag <- c("repshare_lag1", "turnout_lag1", "capital_state_lag1", "lnincome_lag1", "poverty_lag1", 
                 "gini_lag1", "racialhhi_lag1", "mentalhealth_lag1", "pop15t39_lag1", "nevermarried_lag1", "sc_lag1", 
                 "lnhom_gun_lag1", "lnsui_gun_lag1", "lncrime_violent_lag1", "lncrime_proprty_lag1")

indep_vars <- c("ms", "popsd")

# create empty list to store regression results
reg_results <- list()

# Strategy 1 regression

for (var_name in vars_to_lag) {
  
 reg <- plm(as.formula(paste0(var_name, " ~ ", paste(indep_vars, collapse="+"))), 
             data = DF, subset = mse == 0 | ms == 1, index = "fips", 
             model = "random", effect = "twoways", cluster = "group")
  
  reg_results[[var_name]] <- reg
  
}

print(reg_results)

# Export results to regression table using stargazer
# Below code to export regression table should work but it does not flip!

stargazer(reg_results, type = "latex", header = FALSE, title = "County Characteristics",
          column.labels = c("Republican share", "Turnout", 
                            "State capitol",
                            "Log (median HH income)", 
                            "Poverty rate","Inequality (Gini Index)", 
                            "Racial diversity HHI", 
                            "Proportion with mental issues", 
                            "Population 15 to 39 years", "Single",
                            "College dropouts", "Log (homicides by gun)", 
                            "Log (suicides by Gun)","Log (violent crime)",
                            "Log (property crime)"), 
          row.labels = c("Constant", "MS", "Population"),
          flip = TRUE)

# Strategy 2 regression

